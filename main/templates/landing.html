{% load i18n %}

<!DOCTYPE html>
<html>
<head lang="en">
    <!-- Meta info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width" name="viewport">

    <title>Information</title>
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-68574649-1', 'auto');
        ga('send', 'pageview');

    </script>

    <style>
        html, body {
            height: 100%;
            font: Arial, Helvetica, sans-serif;
            color: white !important;
        }

        h1, h2, h3, h4, h5 {
            font: Arial, Helvetica, sans-serif;
        }

        body {
            background-color: #000 !important;
            max-width: 566.9pt;
            padding: 0 10px;
            margin: 5px;
        }

        .lst-kix_6cj4gmv9r21z-0 > li:before {
            color: #fff;
        }

        button {
            border: 1px white solid;
            color: white;
            background-color: black;
            height: 2.5em;
            font-size: 1em;
            width: 100%
        }

        select {
            border: 1px white solid;
            color: white;
            background-color: black;
            height: 2.5em;
            font-size: 1em;
            width: 100%
        }

        .hide {
            display: none;
        }
    </style>
    {% get_current_language as LANGUAGE_CODE %}
    <!-- Current language: {{ LANGUAGE_CODE }} -->

</head>
<body>
<div id="overlay" class="hide">
    <h3>Current Location</h3>

    <h4 id="location_name"></h4>
    <button onclick="load_from_browser()">{% trans "Detect my location" %}</button>
    <br/><br/>
    <select id="language_picker">
        {% for l in languages %}
            <option value="{{ l.iso_code }}">{{ l.name }}</option>
        {% endfor %}
    </select>
    <br/><br/>
    <button onclick="goToPage()" id="go">{% trans "Go to page" %}</button>
</div>
<script>
    window.currentLocation = {{ current_location | safe }};

    function load_from_browser(then) {
        navigator.geolocation.getCurrentPosition(function (position) {
            localStorage.allowedGeolocation = true;

            window.currentPosition = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
            };

            getCurrentLocation(position.coords.latitude, position.coords.longitude, then);
        }, function () {
            document.getElementById('overlay').className = "";
        });
    }

    function goToPage() {
        var language = document.getElementById('language_picker').value;
        location.href = '/' + window.currentLocation.slug + '/' + language + '/';
    }

    window.onload = function () {
        if (!localStorage.allowedGeolocation) {
            document.getElementById('overlay').className = "";

            var language = navigator.language.split('-')[0];
            var location_name = document.getElementById('location_name');
            if (!window.currentLocation.name) {
                location_name.innerHTML = 'Cannot determine location';
                document.getElementById('go').disabled = true;
            } else {
                location_name.innerHTML = window.currentLocation.name + ' (Based on IP)';
            }
            document.querySelector('[value=' + language + ']').selected = true;
        }
        else {
            load_from_browser(goToPage)
        }
    };

    function getCurrentLocation(lat, long, then) {
        var r = new XMLHttpRequest();
        r.open('GET', '{%  url 'lookup-device' %}?lnglat=' + long + ' ' + lat, true);
        r.onreadystatechange = function () {
            if (r.readyState !== 4 || r.status !== 200) {
                            document.getElementById('overlay').className = "";
                return;
            }
            window.currentLocation = JSON.parse(r.responseText);
            document.getElementById('go').disabled = false;
            var location_name = document.getElementById('location_name');
            location_name.innerHTML = window.currentLocation.name + ' (Based on GPS)';

            if (then) {
                then();
            }
        };
        r.send();
    }

</script>
</body>
</html>